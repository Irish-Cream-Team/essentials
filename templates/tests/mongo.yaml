{{- $replicaset := default false .Values.essentials.mongo.replicaset -}}
{{- if .Values.essentials.mongo.enabled -}}
apiVersion: v1
kind: Pod
metadata:
  name: {{ .Values.essentials.mongo.name | default "mongo" }}-test
  labels:
    {{- include "master-chart.labels" . | nindent 4 }}
    app: {{ .Values.essentials.mongo.name | default "mongo"}}
  annotations:
    "helm.sh/hook": test
spec:
  imagePullSecrets:
  {{- range .Values.essentials.mongo.PullSecrets }}
    - name: {{ . }}
  {{- end }}
  containers:
    - name: {{ .Values.essentials.mongo.name | default "mongo"}}-test
      {{- if $replicaset }}
      image: "harborreg-2.northeurope.cloudapp.azure.com/library/mongo:replicaSet"
      lifecycle:
        postStart:
          exec:
            command: 
              - "sh"
              - "-c"
              - >
                while [ "$(grep -v "rem_address" /proc/net/tcp | grep 6989)" = "" ];
                do
                  echo "wating for monog to listen on port 27017"
                done;
                mongo --eval 'rs.initiate({_id: "rs0", members: [{_id: 0, host: "localhost:27017"}]})';     
      {{- else }}
      image: {{ .Values.essentials.mongo.image | default "mongo"}}
      {{- end }}
      command: ["sh", "-c", "mongo --host {{ .Values.essentials.mongo.name | default "mongo"}} --port 27017" ]
      ports:
        - containerPort: {{ .Values.essentials.mongo.port | default "27017"}}
          name: {{ .Values.essentials.mongo.name | default "mongo"}}
  restartPolicy: Never

{{- end -}}
